@let url = kcContext.url;
@let stateChecker = kcContext.stateChecker;
@let applications = kcContext.applications?.applications;

<kc-account-template [active]="'applications'">
  <ng-container content>
    <div class="row">
      <div class="col-md-10">
        <h2>{{ 'applicationsHtmlTitle' | msgStr }}</h2>
      </div>

      <form
        [action]="url.applicationsUrl"
        method="post"
      >
        <input
          type="hidden"
          id="stateChecker"
          name="stateChecker"
          [value]="stateChecker"
        />
        <input
          type="hidden"
          id="referrer"
          name="referrer"
          [value]="stateChecker"
        />

        <table class="table table-striped table-bordered">
          <thead>
            <tr>
              <td>{{ 'application' | msgStr }}</td>
              <td>{{ 'availableRoles' | msgStr }}</td>
              <td>{{ 'grantedPermissions' | msgStr }}</td>
              <td>{{ 'additionalGrants' | msgStr }}</td>
              <td>{{ 'action' | msgStr }}</td>
            </tr>
          </thead>

          <tbody>
            @for (application of applications ?? []; track application) {
              <tr>
                <td>
                  @if (application.effectiveUrl) {
                    <a [href]="application.effectiveUrl">
                      @if (application.client.name) {
                        {{ application.client.name | advancedMsgStr }}
                      } @else {
                        {{ application.client.clientId }}
                      }
                    </a>
                  } @else {
                    @if (application.client.name) {
                      {{ application.client.name | advancedMsgStr }}
                    } @else {
                      {{ application.client.clientId }}
                    }
                  }
                </td>

                <td>
                  @if (!(application.realmRolesAvailable | isArrayWithEmptyObject)) {
                    @for (role of application.realmRolesAvailable; track role; let last = $last) {
                      <span>
                        @if (role.description) {
                          {{ role.description | advancedMsgStr }}
                        } @else {
                          {{ role.name | advancedMsgStr }}
                        }
                        @if (!last) {
                          ,&nbsp;
                        }
                      </span>
                    }
                  }
                  @if (application.resourceRolesAvailable) {
                    @for (resource of application.resourceRolesAvailable | keyvalue; track resource.key) {
                      <span>
                        @if (!(application.realmRolesAvailable | isArrayWithEmptyObject)) {
                          ,&nbsp;
                        }
                        @for (
                          clientRole of application.resourceRolesAvailable[resource.key];
                          track clientRole;
                          let roleLast = $last
                        ) {
                          <span>
                            {{
                              (clientRole.roleDescription ? clientRole.roleDescription : clientRole.roleName)
                                | advancedMsgStr
                            }}
                            {{ 'inResource' | msgStr }}
                            <strong>
                              {{
                                clientRole.clientName ? (clientRole.clientName | advancedMsgStr) : clientRole.clientId
                              }}</strong
                            >
                            @if (!roleLast) {
                              ,&nbsp;
                            }
                          </span>
                        }
                      </span>
                    }
                  }
                </td>

                <td>
                  @if (application.client.consentRequired) {
                    @for (claim of application.clientScopesGranted; track claim; let last = $last) {
                      {{ claim | advancedMsgStr }}
                      @if (!last) {
                        ,&nbsp;
                      }
                    }
                  } @else {
                    <strong>{{ 'fullAccess' | msgStr }}</strong>
                  }
                </td>

                <td>
                  @for (grant of application.additionalGrants; track grant; let last = $last) {
                    {{ grant | advancedMsgStr }}
                    @if (!last) {
                      ,&nbsp;
                    }
                  }
                </td>

                <td>
                  @if (
                    (application.client.consentRequired && application.clientScopesGranted.length > 0) ||
                    application.additionalGrants.length > 0
                  ) {
                    <button
                      type="submit"
                      [kcClass]="['kcButtonPrimaryClass', 'kcButtonClass']"
                      [id]="'revoke-' + application.client.clientId"
                      name="clientId"
                      [value]="application.client.id"
                    >
                      {{ 'revoke' | msgStr }}
                    </button>
                  }
                </td>
              </tr>
            }
          </tbody>
        </table>
      </form>
    </div>
  </ng-container>
</kc-account-template>
